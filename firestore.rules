rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users must be authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user's company_id
    function getUserCompanyId() {
      return isAuthenticated() ? 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id : 
        null;
    }
    
    // Helper function to get user's role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to get user's agency_id
    function getUserAgencyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.agencies_id;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == "admin";
    }
    
    // Helper function to check if user is area manager
    function isAreaManager() {
      return isAuthenticated() && getUserRole() == "area manager";
    }
    
    // Helper function to check if user can manage data (admin or area manager)
    function canManageData() {
      return isAuthenticated() && (getUserRole() == "admin" || getUserRole() == "area manager");
    }
    
    // Helper function to check if user can delete users (admin or area manager)
    function canDeleteUsers() {
      return isAuthenticated() && (getUserRole() == "admin" || getUserRole() == "area manager");
    }
    
    // Helper function to check if user can update users (admin, area manager, sales, warehouse)
    function canUpdateUsers() {
      return isAuthenticated() && (
        getUserRole() == "admin" || 
        getUserRole() == "area manager" || 
        getUserRole() == "sales" || 
        getUserRole() == "warehouse"
      );
    }
    
    // Helper function to check if user can create users (admin, area manager, sales, warehouse)
    function canCreateUsers() {
      return isAuthenticated() && (
        getUserRole() == "admin" || 
        getUserRole() == "area manager" || 
        getUserRole() == "sales" || 
        getUserRole() == "warehouse"
      );
    }
    
    // Helper function to check if user belongs to same company
    function isSameCompany(companyId) {
      return isAuthenticated() && getUserCompanyId() == companyId;
    }
    
    // Users collection
    match /users/{userId} {
      // Un utilisateur peut toujours lire et modifier son propre document
      allow read, update: if isAuthenticated() && request.auth.uid == userId;
      
      // Création : admin, area manager, sales et warehouse peuvent créer des utilisateurs pour leur entreprise
      // Seul un admin peut créer un utilisateur avec le rôle "admin"
      // Les zone managers ne peuvent créer des utilisateurs que pour leur propre agence
      allow create: if canCreateUsers() && 
                       request.resource.data.company_id == getUserCompanyId() &&
                       (request.resource.data.role != "admin" || isAdmin()) &&
                       (!isAreaManager() || getUserAgencyId() == request.resource.data.agencies_id);
      
      // Lecture : les utilisateurs peuvent lire les membres de leur entreprise
      allow read: if isSameCompany(resource.data.company_id);
      
      // Modification : admin, area manager, sales et warehouse peuvent modifier d'autres utilisateurs de leur entreprise
      // Seul un admin peut mettre un utilisateur en admin ou modifier un utilisateur admin
      // Les zone managers ne peuvent modifier que les utilisateurs de leur propre agence
      allow update: if canUpdateUsers() && 
                      resource.data.company_id == getUserCompanyId() &&
                      request.auth.uid != userId && // Ne peut pas se modifier soi-même (utilise la règle ci-dessus)
                      (request.resource.data.role != "admin" || isAdmin()) && // Seul un admin peut mettre le rôle "admin"
                      (resource.data.role != "admin" || isAdmin()) && // Seul un admin peut modifier un utilisateur admin
                      (!isAreaManager() || getUserAgencyId() == resource.data.agencies_id) && // Zone manager ne peut modifier que les utilisateurs de son agence
                      (!isAreaManager() || getUserAgencyId() == request.resource.data.agencies_id); // Zone manager ne peut pas changer l'agence de l'utilisateur
      
      // Suppression : admin et area manager peuvent supprimer d'autres utilisateurs de leur entreprise
      allow delete: if canDeleteUsers() && 
                      resource.data.company_id == getUserCompanyId() &&
                      request.auth.uid != userId; // Ne peut pas se supprimer soi-même
    }
    
    // Companies collection
    match /companies/{companyId} {
      // Lecture : les utilisateurs peuvent lire leur entreprise
      allow read: if isSameCompany(companyId);
      
      // Écriture : uniquement les admins peuvent modifier leur entreprise
      allow write: if isAdmin() && isSameCompany(companyId);
    }
    
    // Products collection
    match /products/{productId} {
      // Lecture : tous les utilisateurs de l'entreprise peuvent lire les produits
      allow read: if isSameCompany(resource.data.company_id);
      
      // Création : admins et area managers peuvent créer des produits
      allow create: if canManageData() && 
                       request.resource.data.company_id == getUserCompanyId();
      
      // Modification/Suppression : admins et area managers peuvent modifier/supprimer
      allow update, delete: if canManageData() && 
                              resource.data.company_id == getUserCompanyId();
    }
    
    // Agencies collection
    match /agencies/{agencyId} {
      // Lecture : tous les utilisateurs de l'entreprise peuvent lire les agences
      allow read: if isSameCompany(resource.data.company_id);
      
      // Création : admins et area managers peuvent créer des agences
      allow create: if canManageData() && 
                       request.resource.data.company_id == getUserCompanyId();
      
      // Modification/Suppression : admins et area managers peuvent modifier/supprimer
      allow update, delete: if canManageData() && 
                              resource.data.company_id == getUserCompanyId();
    }
    
    // Orders collection
    match /orders/{orderId} {
      // Lecture : tous les utilisateurs authentifiés de l'entreprise peuvent lire les commandes de leur entreprise
      // Les clients peuvent aussi lire leurs propres commandes
      allow read: if isAuthenticated() && 
                     (
                       // Client lisant ses propres commandes
                       (getUserRole() == "customer" && resource.data.customer_id == request.auth.uid) ||
                       // Utilisateur de l'entreprise lisant les commandes de son entreprise
                       (getUserCompanyId() != null && resource.data.company_id == getUserCompanyId())
                     );
      
      // Création : les clients peuvent créer leurs propres commandes
      // Les admins, area managers et commerciaux peuvent créer des commandes au nom des clients
      allow create: if isAuthenticated() && 
                       request.resource.data.company_id == getUserCompanyId() &&
                       (
                         // Client créant sa propre commande
                         (getUserRole() == "customer" && 
                          request.resource.data.customer_id == request.auth.uid &&
                          request.resource.data.created_by == request.auth.uid) ||
                         // Admin, area manager ou commercial créant une commande au nom d'un client
                         (getUserRole() == "admin" || 
                          getUserRole() == "area manager" || 
                          getUserRole() == "sales") &&
                         request.resource.data.customer_id is string &&
                         request.resource.data.created_by == request.auth.uid
                       );
      
      // Modification : tous les utilisateurs peuvent modifier les commandes de leur entreprise
      // Les livreurs peuvent modifier uniquement le statut
      allow update: if isAuthenticated() && 
                      resource.data.company_id == getUserCompanyId() &&
                      (
                        getUserRole() != "driver" ||
                        // Les livreurs ne peuvent modifier que le statut et les autres champs doivent rester identiques
                        (getUserRole() == "driver" && 
                         request.resource.data.status is string &&
                         request.resource.data.company_id == resource.data.company_id &&
                         request.resource.data.customer_id == resource.data.customer_id &&
                         request.resource.data.sales_id == resource.data.sales_id &&
                         request.resource.data.created_by == resource.data.created_by &&
                         request.resource.data.created_at == resource.data.created_at)
                      );
      
      // Suppression : admins et area managers peuvent supprimer les commandes de leur entreprise
      allow delete: if canManageData() && 
                      resource.data.company_id == getUserCompanyId();
    }
    
    // Order items collection
    match /order_items/{orderItemId} {
      // Lecture : tous les utilisateurs authentifiés de l'entreprise peuvent lire les order_items de leur entreprise
      allow read: if isAuthenticated() && 
                     getUserCompanyId() != null &&
                     exists(/databases/$(database)/documents/orders/$(resource.data.order_id)) &&
                     get(/databases/$(database)/documents/orders/$(resource.data.order_id)).data.company_id == getUserCompanyId();
      
      // Création : les clients peuvent créer des order_items pour leurs commandes
      // Les admins, area managers et commerciaux peuvent créer des order_items pour les commandes de leur entreprise
      allow create: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/orders/$(request.resource.data.order_id)) &&
                       get(/databases/$(database)/documents/orders/$(request.resource.data.order_id)).data.company_id == getUserCompanyId() &&
                       (
                         // Client créant des order_items pour sa propre commande
                         (getUserRole() == "customer" && 
                          get(/databases/$(database)/documents/orders/$(request.resource.data.order_id)).data.customer_id == request.auth.uid) ||
                         // Admin, area manager ou commercial créant des order_items pour une commande de leur entreprise
                         (getUserRole() == "admin" || 
                          getUserRole() == "area manager" || 
                          getUserRole() == "sales")
                       );
      
      // Modification : tous les utilisateurs sauf les livreurs peuvent modifier les order_items des commandes de leur entreprise
      allow update: if isAuthenticated() && 
                      getUserRole() != "driver" &&
                      exists(/databases/$(database)/documents/orders/$(resource.data.order_id)) &&
                      get(/databases/$(database)/documents/orders/$(resource.data.order_id)).data.company_id == getUserCompanyId();
      
      // Suppression : admins et area managers peuvent supprimer les order_items des commandes de leur entreprise
      allow delete: if canManageData() && 
                      exists(/databases/$(database)/documents/orders/$(resource.data.order_id)) &&
                      get(/databases/$(database)/documents/orders/$(resource.data.order_id)).data.company_id == getUserCompanyId();
    }
    
    // Warehouses collection
    match /warehouses/{warehouseId} {
      // Lecture : tous les utilisateurs de l'entreprise peuvent lire les entrepôts
      allow read: if isSameCompany(resource.data.company_id);
      
      // Création : admins et area managers peuvent créer des entrepôts
      allow create: if canManageData() && 
                       request.resource.data.company_id == getUserCompanyId();
      
      // Modification/Suppression : admins et area managers peuvent modifier/supprimer
      allow update, delete: if canManageData() && 
                              resource.data.company_id == getUserCompanyId();
    }
    
    // Stocks collection
    match /stocks/{stockId} {
      // Lecture : tous les utilisateurs de l'entreprise peuvent lire les stocks
      allow read: if isSameCompany(resource.data.company_id);
      
      // Création : admin, area manager, sales et warehouse peuvent créer des stocks
      allow create: if isAuthenticated() && 
                       (getUserRole() == "admin" || 
                        getUserRole() == "area manager" || 
                        getUserRole() == "sales" || 
                        getUserRole() == "warehouse") &&
                       request.resource.data.company_id == getUserCompanyId();
      
      // Modification : admin, area manager, sales et warehouse peuvent modifier les stocks
      allow update: if isAuthenticated() && 
                       (getUserRole() == "admin" || 
                        getUserRole() == "area manager" || 
                        getUserRole() == "sales" || 
                        getUserRole() == "warehouse") &&
                       resource.data.company_id == getUserCompanyId();
      
      // Suppression : admin, area manager, sales et warehouse peuvent supprimer les stocks
      allow delete: if isAuthenticated() && 
                       (getUserRole() == "admin" || 
                        getUserRole() == "area manager" || 
                        getUserRole() == "sales" || 
                        getUserRole() == "warehouse") &&
                       resource.data.company_id == getUserCompanyId();
    }
    
  }
}
